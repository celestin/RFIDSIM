<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>rfidsim: simulator.hpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.4.7 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="annotated.html"><span>Classes</span></a></li>
    <li id="current"><a href="files.html"><span>Files</span></a></li>
    <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
  </ul></div>
<div class="tabs">
  <ul>
    <li><a href="files.html"><span>File&nbsp;List</span></a></li>
    <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
  </ul></div>
<h1>simulator.hpp</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00002"></a>00002 <span class="preprocessor">#ifndef SIMULATOR_H</span>
<a name="l00003"></a>00003 <span class="preprocessor"></span><span class="preprocessor">#define SIMULATOR_H</span>
<a name="l00004"></a>00004 <span class="preprocessor"></span>
<a name="l00186"></a>00186 <span class="preprocessor">#include &lt;vector&gt;</span>
<a name="l00187"></a>00187 <span class="preprocessor">#include &lt;set&gt;</span>
<a name="l00188"></a>00188 <span class="keyword">using namespace </span>std;
<a name="l00189"></a>00189 <span class="preprocessor">#include &lt;boost/utility.hpp&gt;</span>
<a name="l00190"></a>00190 <span class="preprocessor">#include &lt;boost/smart_ptr.hpp&gt;</span>
<a name="l00191"></a>00191 <span class="preprocessor">#include &lt;boost/enable_shared_from_this.hpp&gt;</span>
<a name="l00192"></a>00192 
<a name="l00193"></a>00193 <span class="preprocessor">#include "<a class="code" href="utility_8hpp.html">utility.hpp</a>"</span>
<a name="l00194"></a>00194 <span class="preprocessor">#include "sim_time.hpp"</span>
<a name="l00195"></a>00195 <span class="preprocessor">#include "event.hpp"</span>
<a name="l00196"></a>00196 <span class="preprocessor">#include "node.hpp"</span>
<a name="l00197"></a>00197 <span class="preprocessor">#include "simulation_end_listener.hpp"</span>
<a name="l00198"></a>00198 
<a name="l00199"></a>00199 <span class="keyword">class </span><a class="code" href="classRandNumGenerator.html">RandNumGenerator</a>;
<a name="l00200"></a>00200 <span class="keyword">typedef</span> boost::shared_ptr&lt;RandNumGenerator&gt; <a class="code" href="classRandNumGenerator.html#6a66f8e312a44856f47f655d7cae85ea">RandNumGeneratorPtr</a>;
<a name="l00201"></a>00201 <span class="keyword">class </span><a class="code" href="classLogStreamManager.html">LogStreamManager</a>;
<a name="l00202"></a>00202 <span class="keyword">typedef</span> <a class="code" href="classLogStreamManager.html">LogStreamManager</a>* <a class="code" href="classLogStreamManager.html">LogStreamManagerPtr</a>;
<a name="l00203"></a>00203 
<a name="l00205"></a>00205 <span class="comment">// EventPtrComparator Class</span>
<a name="l00207"></a>00207 <span class="comment"></span>
<a name="l00214"></a><a class="code" href="classEventPtrComparator.html">00214</a> <span class="keyword">class </span><a class="code" href="classEventPtrComparator.html">EventPtrComparator</a> {
<a name="l00215"></a>00215 <span class="keyword">public</span>:
<a name="l00221"></a>00221    <span class="keyword">inline</span> <span class="keywordtype">bool</span> <a class="code" href="classEventPtrComparator.html#d6fc0f756747ab25d620c471410dbf79">operator() </a>(ConstEventPtr event1, 
<a name="l00222"></a>00222       ConstEventPtr event2) <span class="keyword">const</span>;
<a name="l00223"></a>00223 };
<a name="l00224"></a>00224 
<a name="l00225"></a><a class="code" href="classEventPtrComparator.html#d6fc0f756747ab25d620c471410dbf79">00225</a> <span class="keyword">inline</span> <span class="keywordtype">bool</span> <a class="code" href="classEventPtrComparator.html#d6fc0f756747ab25d620c471410dbf79">EventPtrComparator::operator() </a>(ConstEventPtr event1, 
<a name="l00226"></a>00226    ConstEventPtr event2)<span class="keyword"> const</span>
<a name="l00227"></a>00227 <span class="keyword"></span>{
<a name="l00228"></a>00228    <span class="keywordflow">return</span> *event1 &lt; *event2;
<a name="l00229"></a>00229 }
<a name="l00230"></a>00230 
<a name="l00232"></a>00232 <span class="comment">// Simulator Class</span>
<a name="l00234"></a>00234 <span class="comment"></span>
<a name="l00235"></a>00235 <span class="keyword">typedef</span> multiset&lt;EventPtr,EventPtrComparator&gt; EventPtrQueue;
<a name="l00236"></a>00236 <span class="keyword">typedef</span> EventPtrQueue::iterator EventPtrQueueIterator;
<a name="l00237"></a>00237 
<a name="l00242"></a>00242 <span class="comment">// Declare as noncopyable so the copy constructor and copy </span>
<a name="l00243"></a>00243 <span class="comment">// assignment cannot be used.</span>
<a name="l00244"></a><a class="code" href="classSimulator.html">00244</a> <span class="keyword">class </span><a class="code" href="classSimulator.html">Simulator</a> : boost::noncopyable, 
<a name="l00245"></a>00245       <span class="keyword">public</span> boost::enable_shared_from_this&lt;Simulator&gt; {
<a name="l00246"></a>00246 <span class="keyword">public</span>:
<a name="l00248"></a><a class="code" href="classSimulator.html#d299a610fa90e0fd9f7e1c496976b696">00248</a>    <span class="keyword">typedef</span> <a class="code" href="classSimulator.html">Simulator</a>* <a class="code" href="classSimulator.html">SimulatorPtr</a>;
<a name="l00249"></a>00249 
<a name="l00254"></a>00254    <span class="keyword">static</span> <span class="keyword">inline</span> <a class="code" href="classSimulator.html">SimulatorPtr</a> <a class="code" href="classSimulator.html#bbe443394a220bdf2d78dae21427e2ff">instance</a>();
<a name="l00255"></a>00255 
<a name="l00260"></a>00260    <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="classSimulator.html#59a74311d4f24dbb2704a95de68f7c44">addNode</a>(NodePtr nodeToAdd);
<a name="l00261"></a>00261 
<a name="l00273"></a>00273    <span class="keywordtype">void</span> <a class="code" href="classSimulator.html#1cdffa510681f18c94b16c2040164941">runSimulation</a>(<span class="keyword">const</span> <a class="code" href="classSimTime.html">SimTime</a>&amp; stopTime);
<a name="l00274"></a>00274 
<a name="l00279"></a>00279    <span class="keyword">inline</span> <a class="code" href="classSimTime.html">SimTime</a> <a class="code" href="classSimulator.html#38184caa07e9ec6a1f78d9092f6af4c9">currentTime</a>() <span class="keyword">const</span>;
<a name="l00280"></a>00280 
<a name="l00294"></a>00294    <span class="keyword">inline</span> <span class="keywordtype">bool</span> <a class="code" href="classSimulator.html#8aa7a96d26945218b1b3d9c0d54d744f">scheduleEvent</a>(EventPtr eventToSchedule, 
<a name="l00295"></a>00295       <span class="keyword">const</span> <a class="code" href="classSimTime.html">SimTime</a>&amp; eventDelay);
<a name="l00296"></a>00296 
<a name="l00306"></a>00306    <span class="keyword">inline</span> <span class="keywordtype">bool</span> <a class="code" href="classSimulator.html#9b27ba89f37ae2141279a1baeaa54390">cancelEvent</a>(EventPtr eventToCancel);
<a name="l00307"></a>00307 
<a name="l00313"></a>00313    <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="classSimulator.html#937256387d9765dc8f4ae8eb90aede78">setLogStreamManager</a>(
<a name="l00314"></a>00314          <a class="code" href="classLogStreamManager.html">LogStreamManagerPtr</a> logStreamManager) <span class="keyword">const</span>;
<a name="l00315"></a>00315 
<a name="l00320"></a>00320    <span class="keyword">inline</span> <a class="code" href="classLogStreamManager.html">LogStreamManagerPtr</a> <a class="code" href="classSimulator.html#2c82db3d8c3d557965fe1959173209e4">getLogStreamManager</a>() <span class="keyword">const</span>;
<a name="l00321"></a>00321 
<a name="l00327"></a>00327    <span class="keywordtype">void</span> <a class="code" href="classSimulator.html#1ffe97774797bc019c83bb6a3a11d964">seedRandNumGenerator</a>(<span class="keyword">const</span> <a class="code" href="utility_8hpp.html#b393a696e0318c8ab53ae2a1592e3770">t_uint</a> seed) <span class="keyword">const</span>;
<a name="l00328"></a>00328 
<a name="l00333"></a>00333    <span class="keyword">inline</span> RandNumGeneratorPtr <a class="code" href="classSimulator.html#15ceca72787cb8daea5502a29109d6e4">getRandNumGenerator</a>() <span class="keyword">const</span>;
<a name="l00334"></a>00334 
<a name="l00340"></a>00340    <span class="keywordtype">void</span> <a class="code" href="classSimulator.html#ad68e1807b14ca5bfd11cb7ebba25645">reset</a>();
<a name="l00341"></a>00341 
<a name="l00347"></a>00347    <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="classSimulator.html#fe651dc2a3e749aaa15266d8bc039c7b">addSimulationEndListener</a>(
<a name="l00348"></a>00348       SimulationEndListenerPtr listener);
<a name="l00349"></a>00349 
<a name="l00350"></a>00350 <span class="keyword">private</span>:
<a name="l00351"></a>00351 
<a name="l00353"></a>00353    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">double</span> m_SIM_START_TIME;
<a name="l00354"></a>00354 
<a name="l00357"></a>00357    <span class="keyword">static</span> <a class="code" href="classSimulator.html">SimulatorPtr</a> m_instance;
<a name="l00358"></a>00358 
<a name="l00361"></a>00361    <a class="code" href="classSimTime.html">SimTime</a> m_clock;
<a name="l00362"></a>00362 
<a name="l00367"></a>00367    EventPtrQueue m_eventPtrQueue;
<a name="l00368"></a>00368 
<a name="l00372"></a>00372    <a class="code" href="classLogStreamManager.html">LogStreamManagerPtr</a> m_logStreamManagerPtr;
<a name="l00373"></a>00373 
<a name="l00377"></a>00377    RandNumGeneratorPtr m_randNumGeneratorPtr;
<a name="l00378"></a>00378 
<a name="l00382"></a>00382    vector&lt;SimulationEndListenerPtr&gt; m_simulationEndListeners;
<a name="l00383"></a>00383 
<a name="l00385"></a>00385    <a class="code" href="classSimulator.html">Simulator</a>();
<a name="l00386"></a>00386 
<a name="l00390"></a>00390    ~<a class="code" href="classSimulator.html">Simulator</a>();
<a name="l00391"></a>00391 
<a name="l00401"></a>00401    <span class="keyword">inline</span> <span class="keywordtype">void</span> dispatchEvent(EventPtr event);
<a name="l00402"></a>00402 
<a name="l00408"></a>00408    <span class="keyword">inline</span> EventPtr getNextEvent();
<a name="l00409"></a>00409 
<a name="l00410"></a>00410 };
<a name="l00411"></a>00411 <span class="keyword">typedef</span> <a class="code" href="classSimulator.html">Simulator</a>* <a class="code" href="classSimulator.html">SimulatorPtr</a>;
<a name="l00412"></a>00412 
<a name="l00414"></a>00414 <span class="comment">// Inline Functions</span>
<a name="l00416"></a>00416 <span class="comment"></span>
<a name="l00417"></a><a class="code" href="classSimulator.html#38184caa07e9ec6a1f78d9092f6af4c9">00417</a> <span class="keyword">inline</span> <a class="code" href="classSimTime.html">SimTime</a> <a class="code" href="classSimulator.html#38184caa07e9ec6a1f78d9092f6af4c9">Simulator::currentTime</a>()<span class="keyword"> const</span>
<a name="l00418"></a>00418 <span class="keyword"></span>{
<a name="l00419"></a>00419    <span class="keywordflow">return</span> m_clock;
<a name="l00420"></a>00420 }
<a name="l00421"></a>00421 
<a name="l00422"></a><a class="code" href="classSimulator.html#59a74311d4f24dbb2704a95de68f7c44">00422</a> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="classSimulator.html#59a74311d4f24dbb2704a95de68f7c44">Simulator::addNode</a>(NodePtr nodeToAdd)
<a name="l00423"></a>00423 {
<a name="l00424"></a>00424    <span class="comment">// May keep track of the nodes globally in the future.</span>
<a name="l00425"></a>00425 }
<a name="l00426"></a>00426 
<a name="l00427"></a><a class="code" href="classSimulator.html#8aa7a96d26945218b1b3d9c0d54d744f">00427</a> <span class="keyword">inline</span> <span class="keywordtype">bool</span> <a class="code" href="classSimulator.html#8aa7a96d26945218b1b3d9c0d54d744f">Simulator::scheduleEvent</a>(EventPtr eventToSchedule, 
<a name="l00428"></a>00428    <span class="keyword">const</span> <a class="code" href="classSimTime.html">SimTime</a>&amp; eventDelay)
<a name="l00429"></a>00429 {
<a name="l00430"></a>00430    assert(eventToSchedule != 0);
<a name="l00431"></a>00431    assert(!eventToSchedule-&gt;inEventQueue());
<a name="l00432"></a>00432    assert(eventDelay &gt;= 0.0);
<a name="l00433"></a>00433 
<a name="l00434"></a>00434    eventToSchedule-&gt;setFireTime(<a class="code" href="classSimulator.html#38184caa07e9ec6a1f78d9092f6af4c9">currentTime</a>() + eventDelay);
<a name="l00435"></a>00435    EventPtrQueue::const_iterator insertIterator = 
<a name="l00436"></a>00436       m_eventPtrQueue.insert(eventToSchedule);
<a name="l00437"></a>00437    <span class="keywordtype">bool</span> didInsert = (insertIterator != m_eventPtrQueue.end());
<a name="l00438"></a>00438    <span class="keywordflow">if</span>(didInsert) {
<a name="l00439"></a>00439       eventToSchedule-&gt;setInEventQueue(<span class="keyword">true</span>);
<a name="l00440"></a>00440    }
<a name="l00441"></a>00441    
<a name="l00442"></a>00442    <span class="keywordflow">return</span> didInsert;
<a name="l00443"></a>00443 
<a name="l00444"></a>00444 }
<a name="l00445"></a>00445 
<a name="l00446"></a><a class="code" href="classSimulator.html#9b27ba89f37ae2141279a1baeaa54390">00446</a> <span class="keyword">inline</span> <span class="keywordtype">bool</span> <a class="code" href="classSimulator.html#9b27ba89f37ae2141279a1baeaa54390">Simulator::cancelEvent</a>(EventPtr eventToCancel)
<a name="l00447"></a>00447 {
<a name="l00448"></a>00448    assert(eventToCancel != 0);
<a name="l00449"></a>00449 
<a name="l00450"></a>00450    <span class="comment">// Get the range of elements that match this key (i.e.,</span>
<a name="l00451"></a>00451    <span class="comment">// have the same fire time).</span>
<a name="l00452"></a>00452    pair&lt;EventPtrQueueIterator,EventPtrQueueIterator&gt; keyIteratorPair =
<a name="l00453"></a>00453       m_eventPtrQueue.equal_range(eventToCancel);
<a name="l00454"></a>00454       
<a name="l00455"></a>00455    <span class="keywordtype">bool</span> didErase = <span class="keyword">false</span>;
<a name="l00456"></a>00456    <span class="comment">// If the key was not found, pair.first == pair.second</span>
<a name="l00457"></a>00457    <span class="keywordflow">for</span>(EventPtrQueueIterator keyIterator = keyIteratorPair.first;
<a name="l00458"></a>00458          keyIterator != keyIteratorPair.second; 
<a name="l00459"></a>00459          ++keyIterator) {
<a name="l00460"></a>00460 
<a name="l00461"></a>00461       <span class="comment">// If we iterator finds the pointer we want to delete,</span>
<a name="l00462"></a>00462       <span class="comment">// then erase the element and return.</span>
<a name="l00463"></a>00463       <span class="keywordflow">if</span>(*keyIterator == eventToCancel) {
<a name="l00464"></a>00464          m_eventPtrQueue.erase(keyIterator);
<a name="l00465"></a>00465          eventToCancel-&gt;setInEventQueue(<span class="keyword">false</span>);
<a name="l00466"></a>00466          didErase = <span class="keyword">true</span>;
<a name="l00467"></a>00467          <span class="keywordflow">break</span>;
<a name="l00468"></a>00468       }
<a name="l00469"></a>00469    }
<a name="l00470"></a>00470 
<a name="l00471"></a>00471    <span class="keywordflow">return</span> didErase;
<a name="l00472"></a>00472 }
<a name="l00473"></a>00473 
<a name="l00474"></a><a class="code" href="classSimulator.html#15ceca72787cb8daea5502a29109d6e4">00474</a> <span class="keyword">inline</span> RandNumGeneratorPtr <a class="code" href="classSimulator.html#15ceca72787cb8daea5502a29109d6e4">Simulator::getRandNumGenerator</a>()<span class="keyword"> const</span>
<a name="l00475"></a>00475 <span class="keyword"></span>{
<a name="l00476"></a>00476    assert(m_randNumGeneratorPtr != 0);
<a name="l00477"></a>00477    <span class="keywordflow">return</span> m_randNumGeneratorPtr;
<a name="l00478"></a>00478 }
<a name="l00479"></a>00479 
<a name="l00480"></a><a class="code" href="classSimulator.html#2c82db3d8c3d557965fe1959173209e4">00480</a> <span class="keyword">inline</span> <a class="code" href="classLogStreamManager.html">LogStreamManagerPtr</a> <a class="code" href="classSimulator.html#2c82db3d8c3d557965fe1959173209e4">Simulator::getLogStreamManager</a>()<span class="keyword"> const</span>
<a name="l00481"></a>00481 <span class="keyword"></span>{
<a name="l00482"></a>00482    assert(m_logStreamManagerPtr != 0);
<a name="l00483"></a>00483    <span class="keywordflow">return</span> m_logStreamManagerPtr;
<a name="l00484"></a>00484 }
<a name="l00485"></a>00485 
<a name="l00486"></a><a class="code" href="classSimulator.html#bbe443394a220bdf2d78dae21427e2ff">00486</a> <span class="keyword">inline</span> <a class="code" href="classSimulator.html">SimulatorPtr</a> <a class="code" href="classSimulator.html#bbe443394a220bdf2d78dae21427e2ff">Simulator::instance</a>() 
<a name="l00487"></a>00487 {
<a name="l00488"></a>00488    <span class="comment">// See the Singleton design pattern for an explanation.</span>
<a name="l00489"></a>00489    <span class="keywordflow">if</span>(m_instance == 0) {
<a name="l00490"></a>00490       m_instance = <span class="keyword">new</span> <a class="code" href="classSimulator.html">Simulator</a>();
<a name="l00491"></a>00491    }
<a name="l00492"></a>00492    <span class="keywordflow">return</span> m_instance;
<a name="l00493"></a>00493 }
<a name="l00494"></a>00494 
<a name="l00495"></a>00495 <span class="keyword">inline</span> <span class="keywordtype">void</span> Simulator::dispatchEvent(EventPtr event)
<a name="l00496"></a>00496 {
<a name="l00497"></a>00497    assert(event.get() != 0);
<a name="l00498"></a>00498    <a class="code" href="classSimTime.html">SimTime</a> fireTime = event-&gt;getFireTime();
<a name="l00499"></a>00499    assert(m_clock &lt;= fireTime);
<a name="l00500"></a>00500 
<a name="l00501"></a>00501    m_clock = fireTime;
<a name="l00502"></a>00502    event-&gt;execute();
<a name="l00503"></a>00503 }
<a name="l00504"></a>00504 
<a name="l00505"></a>00505 <span class="keyword">inline</span> EventPtr Simulator::getNextEvent()
<a name="l00506"></a>00506 {
<a name="l00507"></a>00507    EventPtr nextEvent (*m_eventPtrQueue.begin());
<a name="l00508"></a>00508    m_eventPtrQueue.erase(m_eventPtrQueue.begin());
<a name="l00509"></a>00509    nextEvent-&gt;setInEventQueue(<span class="keyword">false</span>);
<a name="l00510"></a>00510    <span class="keywordflow">return</span> nextEvent;
<a name="l00511"></a>00511 }
<a name="l00512"></a>00512 
<a name="l00513"></a><a class="code" href="classSimulator.html#fe651dc2a3e749aaa15266d8bc039c7b">00513</a> <span class="keyword">inline</span> <span class="keywordtype">void</span> <a class="code" href="classSimulator.html#fe651dc2a3e749aaa15266d8bc039c7b">Simulator::addSimulationEndListener</a>(
<a name="l00514"></a>00514    SimulationEndListenerPtr listener)
<a name="l00515"></a>00515 {
<a name="l00516"></a>00516    m_simulationEndListeners.push_back(listener);
<a name="l00517"></a>00517 }
<a name="l00518"></a>00518 
<a name="l00519"></a>00519 <span class="preprocessor">#endif // SIMULATOR_H</span>
<a name="l00520"></a>00520 <span class="preprocessor"></span>
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Dec 12 17:04:39 2006 for rfidsim by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.4.7 </small></address>
</body>
</html>
